var canvas1 = document.getElementById("figure1");
//var canvas2 = document.getElementById("figure2");
//var canvas3 = document.getElementById("figure3");
var ctx1 = canvas1.getContext("2d");
//var ctx2 = canvas2.getContext("2d");
//var ctx3 = canvas3.getContext("2d");

var vertices = [];
var sorted = [[],[],[],[],[],[],[],[],[],[]];

var primes = [211, 241, 277, 313, 353, 389, 431, 461, 499, 547, 587, 617, 653, 691, 739, 773, 823, 859, 907, 947, 991, 1031, 1063, 1103, 1153, 1201, 1237, 1289, 1319, 1381, 1433, 1471, 1499, 1553, 1597, 1621, 1669, 1723, 1777, 1823, 1873, 1913, 1979, 2011, 2063, 2099, 2141, 2207, 2251, 2293, 2341, 2381, 2417, 2467, 2539, 2591, 2647, 2683, 2711, 2749, 2797, 2843, 2897, 2953, 3001, 3049, 3109, 3169, 3217, 3259, 3319, 3359, 3407, 3463, 3517, 3547, 3593, 3637, 3691, 3733, 3793, 3847, 3889, 3929, 4001, 4027, 4091, 4133, 4201, 4241, 4273, 4339, 4397, 4451, 4507, 4549, 4603, 4651, 4703, 4759, 4801, 4877, 4933, 4969, 5009, 5059, 5107, 5171, 5231, 5281, 5347, 5407, 5441, 5483, 5527, 5581, 5651, 5689, 5741, 5801, 5843, 5869, 5927, 6011, 6067, 6113, 6163, 6217, 6269, 6311, 6353, 6389, 6469, 6547, 6577, 6653, 6691, 6737, 6793, 6841, 6899, 6959, 6991, 7039, 7109, 7177, 7219, 7283, 7333, 7417, 7481, 7523, 7559, 7591, 7649, 7699, 7753, 7823, 7877, 7927, 7993, 8059, 8101, 8167, 8221, 8269, 8311, 8377, 8431, 8513, 8563, 8623, 8669, 8707, 8747, 8807, 8849, 8923, 8969, 9013, 9067, 9137, 9187, 9239, 9293, 9343, 9403, 9437, 9479, 9539, 9619, 9661, 9721, 9769, 9817, 9859, 9923, 9973, 10067, 10103, 10159, 10211, 10267, 10313, 10357, 10433, 10487, 10559, 10613, 10663, 10723, 10781, 10853, 10891, 10957, 11027, 11083, 11131, 11177, 11257, 11311, 11369, 11437, 11489, 11549, 11617, 11689, 11743, 11807, 11839, 11909, 11953, 12007, 12071, 12113, 12163, 12241, 12281, 12347, 12409, 12457, 12503, 12547, 12601, 12647, 12703, 12763, 12823, 12899, 12941, 12983, 13037, 13103, 13159, 13217, 13267, 13331, 13399, 13457, 13513, 13591, 13649, 13693, 13729, 13789, 13859, 13903, 13963, 14029, 14083, 14159, 14243, 14321, 14387, 14423, 14479, 14543, 14591, 14639, 14713, 14747, 14783, 14843, 14891, 14951, 15031, 15091, 15139, 15199, 15263, 15299, 15349, 15391, 15451, 15511, 15581, 15641, 15671, 15737, 15787, 15823, 15901, 15959, 16033, 16073, 16127, 16193, 16253, 16339, 16411, 16451, 16519, 16573, 16649, 16693, 16759, 16831, 16901, 16943, 17011, 17047, 17117, 17189, 17239, 17321, 17377, 17417, 17471, 17509, 17579, 17627, 17707, 17761, 17837, 17903, 17939, 17987, 18049, 18119, 18149, 18217, 18257, 18311, 18371, 18433, 18481, 18539, 18617, 18701, 18757, 18839, 18917, 19001, 19069, 19139, 19207, 19249, 19309, 19387, 19427, 19463, 19501, 19559, 19609, 19709, 19759, 19819, 19889, 19949, 19993, 20047, 20107, 20147, 20201, 20269, 20341, 20389, 20441, 20509, 20563, 20641, 20719, 20759, 20849, 20899, 20959, 21013, 21061, 21139, 21179, 21227, 21317, 21379, 21419, 21493, 21529, 21587, 21617, 21701, 21757, 21817, 21863, 21937, 22003, 22051, 22093, 22147, 22193, 22277, 22343, 22397, 22469, 22541, 22613, 22651, 22709, 22751, 22811, 22877, 22961, 23017, 23053, 23087, 23167, 23209, 23293, 23339, 23431, 23531, 23563, 23609, 23669, 23741, 23773, 23831, 23887, 23929, 24001, 24049, 24097, 24133, 24197, 24251, 24371, 24419, 24481, 24547, 24631, 24697, 24781, 24847, 24917, 24971, 25033, 25111, 25163, 25229, 25301, 25343, 25409, 25457, 25541, 25601, 25643, 25703, 25763, 25841, 25903, 25943, 26003, 26083, 26141, 26189, 26251, 26309, 26371, 26423, 26489, 26561, 26641, 26693, 26723, 26783, 26849, 26893, 26953, 27017, 27073, 27127, 27239, 27281, 27367, 27437, 27509, 27581, 27653, 27733, 27763, 27799, 27847, 27919, 27967, 28031, 28097, 28163, 28229, 28307, 28393, 28439, 28513, 28559, 28603, 28643, 28687, 28751, 28807, 28867, 28927, 29017, 29063, 29137, 29191, 29243, 29311, 29383, 29423, 29483, 29569, 29629, 29683, 29761, 29851, 29917, 29989];

for (let i = 0; i < 512; i++)
{
    const v = [];
    let z = i;
    let s = 0;
    for (let j = 0; j < 9; j++)
    {
        v.push((z % 2 == 0) ? 0 : 1);
        s += v[v.length-1];
        z = Math.floor(z/2);
    }
    sorted[s].push(i);
    vertices.push(v);
}

var edges = [];
for (let i = 0; i < 9; i++)
{
    const l1 = sorted[i];
    const l2 = sorted[i+1];
    for (let j = 0; j < l1.length; j++)
    {
        const v1 = vertices[l1[j]];
        for (let k = 0; k < l2.length; k++)
        {
            const v2 = vertices[l2[k]];
            let s = 0;
            for (let vi = 0; vi < 9; vi++)
            {
                if (v1[vi] != v2[vi]) s += 1;
            }
            if (s == 1) edges.push([l1[j], l2[k]]);
        }
    }
}

var states = [];
for (let i = 0; i < 512; i++)
{
    const j = (i * 97)%512
    states.push([Math.cos(Math.PI*j/256) + (i*0.2 % 0.7), Math.sin(Math.PI*j/256) + (i*0.9 % 0.56), 0, 0]);
}

var timecode = 0;
function dynamics()
{
    //timecode = (timecode + 1) % primes.length;
    //timecode = 0;
    const springk = 0.01;
    const repel = 0.001;
    for (let i = 0; i < edges.length; i++)
    {
        const idx = edges[i][0];
        const jdx = edges[i][1];
        const x1 = states[idx][0];
        const y1 = states[idx][1];
        const x2 = states[jdx][0];
        const y2 = states[jdx][1];
        
        const dx = x1 - x2;
        const dy = y1 - y2;
        const fx = dx * springk;
        const fy = dy * springk;

        states[idx][2] += -fx;
        states[idx][3] += -fy;
        states[jdx][2] += fx;
        states[jdx][3] += fy;
    }
    let s = 0;
    for (let idx = 0; idx < states.length; idx++)
    {
        for (let jdx = 0; jdx < states.length; jdx++)
        //for (let zdx = 0; zdx < 20; zdx++)
        {
            //jdx = (primes[(idx + timecode) % primes.length] * (zdx+1)) % states.length;
            if (idx == jdx) continue;
            const x1 = states[idx][0];
            const y1 = states[idx][1];
            const x2 = states[jdx][0];
            const y2 = states[jdx][1];
            
            const dx = x1 - x2;
            const dy = y1 - y2;

            const d = Math.pow( Math.pow(dx,2) + Math.pow(dy,2), 1.5 );
            const unitdx = dx/Math.max(d, 0.01);
            const unitdy = dy/Math.max(d, 0.01);
            const fx = unitdx * repel;
            const fy = unitdy * repel;

            states[idx][2] += fx;
            states[idx][3] += fy;
            states[jdx][2] += -fx;
            states[jdx][3] += -fy;
        }
    }
    for (let i = 0; i < states.length; i++)
    {
        states[i][2] = states[i][2] * 0.9;
        states[i][3] = states[i][3] * 0.9;
    }
    for (let i = 0; i < states.length; i++)
    {
        states[i][0] += states[i][2];
        states[i][1] += states[i][3];
    }
}

function normalize(coords, w, h)
{
    const transformed = [];
    
    let minx = 1000;
    let miny = 1000;
    let maxx = -1000;
    let maxy = -1000;
    for (let i = 0; i < coords.length; i++)
    {
        const x = states[i][0];
        const y = states[i][1];
        minx = Math.min(x, minx);
        maxx = Math.max(x, maxx);
        miny = Math.min(y, miny);
        maxy = Math.max(y, maxy);
    }
    const xw = Math.max(maxx - minx, 0.0001);
    const yw = Math.max(maxy - miny, 0.0001);
    for (let i = 0; i < states.length; i++)
    {
        let x = (states[i][0] - minx)/xw;
        let y = (states[i][1] - miny)/yw;

        x = (x*0.96) + 0.02;
        y = (y*0.96) + 0.02;

        x = x*w;
        y = y*h;
        transformed.push([x,y]);
    }
    return transformed
}

function updateNeighbours(edges, arr, arr2)
{
    for (let i = 0; i < edges.length; i++)
    {
        if (arr[edges[i][0]] || arr[edges[i][1]])
        {
            arr2[edges[i][0]] = true;
            arr2[edges[i][1]] = true;
        }
    }
}

var clickCoord = null;
var selected = [];
var dist1 = [];
var dist2 = [];
var dist3 = [];
for (let i = 0; i < states.length; i++)
{
    selected.push(i == 305);
    //selected.push(i == 493);
    dist1.push(false);
    dist2.push(false);
    dist3.push(false);
}
updateNeighbours(edges, selected, dist1);
updateNeighbours(edges, dist1, dist2);
updateNeighbours(edges, dist2, dist3);

var drawxx = [310,258,379,327,387,335,463,407,354,306,429,379,440,391,507,453,286,236,353,304,359,307,429,383,328,279,405,358,411,367,472,431,278,240,354,307,357,309,429,379,330,286,404,354,411,359,472,416,252,198,333,279,334,280,414,353,304,247,392,330,394,328,459,407,321,266,387,341,397,349,470,416,371,313,439,389,449,400,514,462,299,248,368,311,360,314,431,385,334,291,410,369,404,375,466,437,288,247,368,318,367,316,443,394,331,292,417,369,422,377,489,438,265,221,344,291,343,296,418,373,317,265,396,346,403,354,467,421,452,403,515,468,528,475,595,543,496,450,562,513,569,524,623,581,427,381,487,446,495,453,560,521,473,435,543,502,538,508,599,570,425,380,482,435,495,444,564,505,463,409,528,469,535,479,591,537,411,353,477,422,488,434,562,506,458,403,533,473,539,483,599,553,469,418,537,491,536,485,600,557,511,464,581,531,574,537,627,595,437,391,498,455,492,454,553,520,475,441,544,508,528,511,589,572,439,391,500,451,512,459,581,526,480,430,544,493,554,506,609,562,419,367,484,433,491,444,564,515,463,417,537,490,538,498,599,565,75,41,144,104,152,102,226,179,124,77,196,150,205,156,274,222,79,31,134,86,150,95,212,159,114,58,180,128,189,139,249,200,69,51,129,111,134,96,201,164,121,87,186,147,185,141,250,203,45,13,101,64,111,61,179,128,86,38,152,100,149,94,221,170,87,43,158,114,167,111,237,185,135,78,206,151,217,164,281,226,103,49,160,106,172,112,231,177,134,75,195,145,205,158,259,215,70,42,132,103,141,97,208,167,119,80,188,146,194,153,259,212,59,18,115,71,129,79,191,143,97,43,163,110,172,124,236,188,217,173,284,238,296,245,377,333,269,223,349,298,348,295,424,376,203,153,262,214,272,223,348,299,246,199,321,272,323,273,392,353,203,174,265,236,272,230,350,307,256,209,327,280,329,270,392,341,178,126,239,189,252,203,328,272,224,168,291,239,299,244,370,318,233,183,309,259,313,255,392,337,288,230,363,307,364,307,441,387,224,170,280,231,287,237,355,310,261,212,331,284,333,285,400,363,209,169,273,230,284,235,359,311,258,212,333,281,337,287,404,355,187,134,250,200,259,210,337,286,232,175,304,252,313,260,376,333];
var drawyy = [297,232,296,229,319,251,314,242,262,201,257,197,282,219,284,216,545,479,536,474,561,499,551,492,509,444,498,441,526,463,514,456,155,92,147,79,173,106,169,100,117,57,108,48,141,73,142,72,400,336,397,331,419,359,416,354,365,299,360,295,387,321,381,314,382,312,377,310,399,332,398,330,350,278,344,276,361,293,364,290,617,560,603,551,627,578,613,569,596,522,574,513,601,540,582,526,227,167,219,158,243,181,239,179,206,133,187,125,212,148,211,146,471,412,463,405,486,427,476,425,437,379,430,374,454,394,444,391,266,202,261,197,292,227,288,219,241,179,238,173,263,198,258,191,504,446,491,435,521,462,498,445,472,415,454,404,480,425,456,410,124,52,122,52,153,80,156,78,97,34,100,37,127,63,135,67,366,292,365,296,383,320,381,308,331,261,319,261,348,285,342,281,345,275,335,265,369,306,367,303,327,243,307,239,332,263,324,258,577,517,556,500,586,536,562,516,549,482,521,467,549,491,519,471,198,128,193,124,222,158,223,154,175,100,172,100,196,128,199,126,438,374,426,371,451,396,437,388,414,347,397,333,420,356,406,355,285,233,283,220,306,243,292,225,250,203,243,190,269,214,266,202,513,441,512,443,540,467,540,467,486,417,482,419,516,446,512,443,169,121,148,92,173,119,158,94,123,78,102,53,140,83,122,63,381,316,377,310,400,335,398,334,335,272,335,273,374,303,366,296,358,297,356,293,382,317,379,310,315,258,319,257,344,276,347,273,573,505,577,513,603,540,606,543,560,483,560,487,588,518,588,516,230,184,214,160,236,186,224,168,194,142,177,120,205,149,194,136,448,383,442,378,466,402,462,400,419,352,411,349,444,378,436,373,249,196,246,185,266,209,260,189,215,164,213,155,234,178,231,168,494,429,492,426,515,452,509,448,461,403,458,398,482,421,473,414,114,58,100,39,126,66,116,43,71,27,61,13,89,37,81,23,348,274,347,279,364,295,362,292,310,242,308,242,330,263,329,259,326,258,318,252,345,279,340,274,286,224,281,220,310,242,303,239,568,498,567,499,592,532,583,524,539,471,534,467,560,493,548,484,184,125,177,114,200,142,194,130,148,89,140,79,165,104,161,94,424,356,421,358,443,382,440,378,393,325,389,321,411,343,408,342];
function draw1()
{
    const ctx = ctx1;
    const w = 640;
    const h = 640;

    ctx.clearRect(0,0,w,h);
    if (clickCoord !== null)
    {
        const x = clickCoord[0] * w;
        const y = clickCoord[1] * h;
        let mindist = 1000000;
        let selection = -1;
        for (let i = 0; i < states.length; i++)
        {
            const d = Math.pow(x-drawxx[i], 2) + Math.pow(y-drawyy[i], 2);
            if (d < 1024 && d < mindist)
            {
                mindist = d;
                selection = i;
            }
        }
        if (selection >= 0)
        {
            selected[selection] = !selected[selection];
            for (let i = 0; i < dist1.length; i++) dist1[i] = false;
            for (let i = 0; i < dist2.length; i++) dist2[i] = false;
            for (let i = 0; i < dist3.length; i++) dist3[i] = false;
            updateNeighbours(edges, selected, dist1);
            updateNeighbours(edges, dist1, dist2);
            updateNeighbours(edges, dist2, dist3);
        }
        clickCoord = null;
    }

    ctx.globalAlpha = 0.25;
    for (let i = 0; i < edges.length; i++)
    {
        const idx = edges[i][0];
        const jdx = edges[i][1];
        const x1 = drawxx[idx];
        const y1 = drawyy[idx];
        const x2 = drawxx[jdx];
        const y2 = drawyy[jdx];
        if (selected[idx] || selected[jdx])
        {
            ctx.globalAlpha = 1;
            ctx.strokeStyle = "white";
        }
        else if (dist3[idx] && dist3[jdx])
        {
            ctx.globalAlpha = 0.6;
            ctx.strokeStyle = "silver";
        }
        else
        {
            ctx.globalAlpha = 0.2;
            ctx.strokeStyle = "grey";
        }
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }
    for (let i = 0; i < states.length; i++)
    {
        const x = drawxx[i];
        const y = drawyy[i];
        let pixcol = "rgb(64,64,64)";
        if (selected[i])
        {
            pixcol = "white";
            ctx.globalAlpha = 1;
            ctx.fillStyle = "white";
            ctx.fillRect(x-6, y-6, 13, 13);
        }
        else if (dist3[i])
        {
            pixcol = "silver";
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "silver";
            ctx.fillRect(x-5, y-5, 11, 11);
        }
        else
        {
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "grey";
            ctx.fillRect(x-5, y-5, 11, 11);
        }
        ctx.globalAlpha = 1;
        ctx.fillStyle = "black";
        ctx.fillRect(x-4, y-4, 9, 9);
        ctx.fillStyle = pixcol;
        for (let vi = 0; vi < 9; vi++)
        {
            if (vertices[i][vi] == 0) ctx.fillRect(x + ((vi%3)*3) - 4, y + (Math.floor(vi/3)*3) - 4, 3, 3);
        }

        //ctx.beginPath();
        //ctx.arc(x, y, w/64, 0, 2 * Math.PI, false);
        //ctx.fillStyle = "black";
        //ctx.fill();
    }
}

/*
function loop()
{
    dynamics();
    draw1();
    setTimeout( () => { window.requestAnimationFrame(loop); }, 1000/12 );
}
window.requestAnimationFrame(loop);
*/

function getCanvasCoord (e, canvas) {
	const boundingBox = canvas.getBoundingClientRect();
    return [e.offsetX/boundingBox.width, e.offsetY/boundingBox.height];
}

canvas1.onmousedown = (e) => {
    clickCoord = getCanvasCoord(e, canvas1);
    draw1();
}
draw1();